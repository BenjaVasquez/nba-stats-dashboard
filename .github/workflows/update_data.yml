name: Actualizar Estadisticas NBA
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # Permite el botón manual en GitHub
  repository_dispatch: # PERMITE EL BOTÓN DE TU WEB
    types: [trigger-update]

jobs:
  extract_stats:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        part: [1, 2, 3, 4]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: pip install pandas nba_api
      - name: Run Part ${{ matrix.part }}
        run: python fetch_nba_p${{ matrix.part }}.py
      - name: Upload Part Result
        uses: actions/upload-artifact@v4
        with:
          name: data_part_${{ matrix.part }}
          path: data_p${{ matrix.part.json }}

  merge_and_deploy:
    needs: extract_stats
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download All Parts
        uses: actions/download-artifact@v4
        with:
          pattern: data_part_*
          merge-multiple: true # ESTO ARREGLA EL ERROR DE "0 JUGADORES"
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install All Dependencies # ESTO ARREGLA EL ERROR DE LA IMAGEN 2
        run: pip install pandas nba_api requests beautifulsoup4
      - name: Merge and Fetch Injuries
        run: |
          python merge_data.py
          python process_fixture.py
          python fetch_injuries.py
          python fetch_bios_salaries.py
          
      - name: Commit and Push
        run: |
          git config --global user.name 'NBA Bot'
          git config --global user.email 'bot@nba.com'
          git add data.json injuries.json
          git commit -m "Actualización completa" || echo "No hay cambios"
          git push
